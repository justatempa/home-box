// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum ConfigScope {
  SYSTEM
  OWNER
}

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String
  role         Role     @default(USER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  categories Category[]
  items      Item[]
  tags       Tag[]
  comments   Comment[]
  templates  Template[]
  dictionaries Dictionary[]

  @@index([isActive])
}

model Category {
  id            String   @id @default(cuid())
  ownerId       String
  name          String
  description   String?
  coverImageUrl String?
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  owner  User            @relation(fields: [ownerId], references: [id])
  images CategoryImage[]
  items  Item[]

  @@unique([ownerId, name])
  @@index([ownerId, deletedAt])
}

model CategoryImage {
  id        String   @id @default(cuid())
  ownerId   String
  categoryId String
  url       String
  sortOrder Int      @default(0)
  width     Int?
  height    Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  category Category @relation(fields: [categoryId], references: [id])

  @@index([ownerId, categoryId, deletedAt])
}

model Item {
  id                String   @id @default(cuid())
  ownerId           String
  name              String
  categoryId        String?
  parentId          String?
  coverImageId      String?  @unique
  inboundAt         DateTime @default(now())
  statusValue       String?
  acquireMethodValue String?
  price             Int      @default(0)
  isFavorite        Boolean  @default(false)
  rating            Int      @default(0)
  note              String?
  tagNamesSnapshot  Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime?

  owner      User          @relation(fields: [ownerId], references: [id])
  category   Category?     @relation(fields: [categoryId], references: [id])
  parent     Item?         @relation("ItemAccessory", fields: [parentId], references: [id])
  accessories Item[]       @relation("ItemAccessory")
  images     ItemImage[]
  tags       ItemTag[]
  templates  ItemTemplate[]
  comments   Comment[]

  coverImage ItemImage? @relation("ItemCover", fields: [coverImageId], references: [id])

  @@index([ownerId, deletedAt])
  @@index([ownerId, inboundAt])
  @@index([ownerId, categoryId])
  @@index([ownerId, parentId, deletedAt])
  @@index([ownerId, statusValue])
  @@index([ownerId, isFavorite])
}

model ItemImage {
  id        String   @id @default(cuid())
  ownerId   String
  itemId    String
  url       String
  sortOrder Int      @default(0)
  alt       String?
  width     Int?
  height    Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  item        Item  @relation(fields: [itemId], references: [id])
  coverForItem Item? @relation("ItemCover")

  @@index([ownerId, itemId, deletedAt])
}

model Tag {
  id         String   @id @default(cuid())
  ownerId    String
  name       String
  color      String?
  usageCount Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  deletedAt  DateTime?

  owner User @relation(fields: [ownerId], references: [id])
  items ItemTag[]

  @@unique([ownerId, name])
  @@index([ownerId, deletedAt])
}

model ItemTag {
  id              String   @id @default(cuid())
  ownerId          String
  itemId          String
  tagId           String?
  tagNameSnapshot String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  item Item @relation(fields: [itemId], references: [id])
  tag  Tag? @relation(fields: [tagId], references: [id])

  @@index([ownerId, itemId, deletedAt])
  @@index([ownerId, tagId, deletedAt])
}

model Template {
  id            String      @id @default(cuid())
  scope         ConfigScope @default(OWNER)
  scopeOwner    String
  ownerId       String?
  templateGroup String
  templateName  String
  schema        Json
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?

  owner User? @relation(fields: [ownerId], references: [id])

  @@unique([scopeOwner, templateGroup, templateName])
  @@index([scopeOwner, deletedAt])
}

model ItemTemplate {
  id                  String   @id @default(cuid())
  ownerId             String
  itemId              String
  templateGroupSnapshot String
  templateNameSnapshot  String
  schemaSnapshot      Json?
  values              Json
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  deletedAt           DateTime?

  item Item @relation(fields: [itemId], references: [id])

  @@index([ownerId, itemId, deletedAt])
}

model Dictionary {
  id         String      @id @default(cuid())
  scope      ConfigScope @default(SYSTEM)
  scopeOwner String
  ownerId    String?
  code       String
  name       String
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  deletedAt  DateTime?

  owner User? @relation(fields: [ownerId], references: [id])
  items DictionaryItem[]

  @@unique([scopeOwner, code])
  @@index([scopeOwner, deletedAt])
}

model DictionaryItem {
  id             String   @id @default(cuid())
  dictionaryId   String
  dictionaryCode String
  value          String
  label          String
  sortOrder      Int      @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deletedAt      DateTime?

  dictionary Dictionary @relation(fields: [dictionaryId], references: [id])

  @@unique([dictionaryId, value])
  @@index([dictionaryCode, isActive, deletedAt])
}

model Comment {
  id              String   @id @default(cuid())
  ownerId          String
  itemId          String
  parentId        String?
  replyToCommentId String?
  content         String
  authorId        String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  owner  User @relation(fields: [ownerId], references: [id])
  item   Item @relation(fields: [itemId], references: [id])
  parent Comment? @relation("CommentThread", fields: [parentId], references: [id])
  replies Comment[] @relation("CommentThread")

  @@index([ownerId, itemId, parentId, deletedAt])
}
